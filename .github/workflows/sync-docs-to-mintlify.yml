name: üìö Sync Docs to Mintlify

on:
  push:
    branches:
      - main
    paths:
      - "**/*.md"
      - ".github/workflows/sync-docs.yml"

concurrency:
  group: sync-docs-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: üîÑ Checkout Source Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: üìÇ Checkout Target Docs Repository
        uses: actions/checkout@v4
        with:
          repository: andreisacal/mintlify-test
          token: ${{ secrets.DOCS_REPO_TOKEN }}
          path: docs-repo

      - name: ‚ö° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üîç Detect and Validate Changed Markdown Files
        id: detect
        run: |
          echo "üìÑ Detecting changed Markdown files..."
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD -- '*.md' 2>/dev/null || git ls-tree --name-only -r HEAD -- '*.md')
          
          echo "üìå Validating Markdown formatting..."
          npm install -g markdownlint-cli
          VALIDATION_ERRORS=""
          
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              if ! markdownlint "$file" 2>/dev/null; then
                VALIDATION_ERRORS="${VALIDATION_ERRORS}‚ö†Ô∏è $file has formatting issues\n"
              fi
            fi
          done <<< "$CHANGED_FILES"
          
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "validation_errors<<EOF" >> $GITHUB_OUTPUT
          echo -e "$VALIDATION_ERRORS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: üöÄ Sync Markdown Files to Target Repo
        id: sync
        run: |
          SYNCED_FILES=""
          FAILED_FILES=""
          
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              target_path="docs-repo/$file"
              mkdir -p "$(dirname "$target_path")"
              
              if cp "$file" "$target_path"; then
                SYNCED_FILES="${SYNCED_FILES}‚úÖ $file\n"
              else
                FAILED_FILES="${FAILED_FILES}‚ùå $file\n"
              fi
            fi
          done <<< "${{ steps.detect.outputs.changed_files }}"
          
          echo "synced_files<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SYNCED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "failed_files<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FAILED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: üì¨ Create Pull Request for Docs Sync
        uses: peter-evans/create-pull-request@v5
        if: steps.sync.outputs.synced_files != ''
        with:
          token: ${{ secrets.DOCS_REPO_TOKEN }}
          path: docs-repo
          commit-message: "docs: sync from main repository"
          branch: auto-sync/${{ github.sha }}
          delete-branch: true
          title: "üìö Sync Documentation from Main Repository"
          body: |
            ## Documentation Sync
            
            **Source:** ${{ github.repository }}@${{ github.sha }}
            **Triggered by:** ${{ github.actor }}
            
            ### ‚úÖ Synced Files
            ${{ steps.sync.outputs.synced_files }}
            
            ### ‚ö†Ô∏è Validation Warnings
            ${{ steps.detect.outputs.validation_errors }}
            
            ### ‚ùå Failed Files
            ${{ steps.sync.outputs.failed_files }}
            
            ---
            *This PR was automatically generated by the docs sync workflow.*

      - name: üìä Job Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # üìö Documentation Sync Summary
          
          ## ‚úÖ Synced Files
          ${{ steps.sync.outputs.synced_files }}
          
          ## ‚ö†Ô∏è Validation Warnings
          ${{ steps.detect.outputs.validation_errors }}
          
          ## ‚ùå Failed Files
          ${{ steps.sync.outputs.failed_files }}
          EOF
